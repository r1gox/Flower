<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro Nacional de Infieles</title>
<style>
:root{--azul:#007bff;--rojo:#dc3545;--verde:#28a745;--naranja:#fd7e14;--fondo:#f8f9fa;--blanco:#fff;--gris:#6c757d;--texto:#212529}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,Arial,sans-serif;background:var(--fondo);color:var(--texto);max-width:500px;margin:0 auto;min-height:100vh}

header{text-align:center;padding:35px 15px;background:var(--blanco);border-bottom:5px solid var(--azul)}
h1{font-size:2.1em;color:var(--azul)}

.btn{padding:15px;font-size:1em;border:none;border-radius:10px;font-weight:bold;width:100%;margin-top:10px}
.btn-azul{background:var(--azul);color:white}
.btn-rojo{background:var(--rojo);color:white}

#lista-infieles{padding:15px}
.card{background:white;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.1);margin-bottom:15px}
.card-header{background:var(--azul);color:white;padding:15px;border-radius:14px 14px 0 0;text-align:center}
.card-body{padding:15px}

.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:1000;justify-content:center;align-items:center}
.modal.active{display:flex}

.modal-content{background:white;width:95%;max-height:95vh;overflow:auto;border-radius:14px;padding:22px}

.close{float:right;font-size:28px;cursor:pointer}

.votos{display:flex;gap:10px;margin:16px 0}
.voto-btn{flex:1;border:none;color:white;padding:12px;border-radius:8px;font-weight:bold}
.verde{background:var(--verde)}
.rojo{background:var(--rojo)}
.naranja{background:var(--naranja)}

.progress{height:12px;background:#ddd;border-radius:8px;overflow:hidden;margin:6px 0}
.bar{height:100%}

.comentarios{margin-top:25px}
.comentario{background:#f1f1f1;padding:12px;border-radius:10px;margin:10px 0}

img{width:100%;border-radius:10px;margin-top:10px}

.subiendo{color:var(--azul);animation:blink 1s infinite}
@keyframes blink{50%{opacity:.4}}
input,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;margin:6px 0}
</style>
</head>

<body>

<header>
<h1>Registro de Infieles</h1>
<button class="btn btn-azul" onclick="document.getElementById('modal-form').classList.add('active')">+ Exponer Infiel</button>
</header>

<div id="lista-infieles"></div>

<!-- MODAL FORMULARIO -->
<div class="modal" id="modal-form">
<div class="modal-content">
<span class="close" onclick="this.parentNode.parentNode.classList.remove('active')">×</span>
<h2>Nuevo Chisme</h2>

<input id="reportero" placeholder="Tu nick (opcional)">
<input id="nombre" placeholder="Nombre">
<input id="apellido" placeholder="Apellido">
<input id="edad" type="number" placeholder="Edad">
<input id="ubicacion" placeholder="Ubicación">
<textarea id="historia" placeholder="Historia completa"></textarea>
<input id="pruebas" type="file" multiple>
<div id="estadoSubida"></div>

<button class="btn btn-azul" onclick="publicar()">Publicar</button>
</div>
</div>

<!-- MODAL DETALLE -->
<div class="modal" id="modal-detalle">
<div class="modal-content">
<span class="close" onclick="this.parentNode.parentNode.classList.remove('active')">×</span>
<div id="detalle-chisme"></div>
</div>
</div>

<script>
async function publicar(){
const files=[...document.getElementById("pruebas").files];
document.getElementById("estadoSubida").innerHTML='<p class="subiendo">Subiendo pruebas…</p>';

const imgs=[];
for(let f of files){
const fr=new FileReader();
fr.onload=()=>imgs.push(fr.result);
fr.readAsDataURL(f);
await new Promise(r=>setTimeout(r,500));
}

await fetch('/.netlify/functions/infieles',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
reportero:reportero.value||"Anónimo",
nombre:nombre.value,
apellido:apellido.value,
edad:edad.value,
ubicacion:ubicacion.value,
historia:historia.value,
imagenes:imgs
})
});

estadoSubida.innerHTML='';
document.getElementById('modal-form').classList.remove('active');
cargar();
}

async function cargar(){
const r=await fetch('/.netlify/functions/infieles');
const data=await r.json();
const box=document.getElementById("lista-infieles");
box.innerHTML='';

data.forEach(i=>{
box.innerHTML+=`
<div class="card">
<div class="card-header">${i.nombre} ${i.apellido}</div>
<div class="card-body">
<p>${i.ubicacion}</p>
<button class="btn btn-azul" onclick="verChisme(${i.id})">Ver todo el chisme</button>
</div>
</div>`;
});
}
cargar();

function verChisme(id){
fetch('/.netlify/functions/infieles?id='+id)
.then(r=>r.json())
.then(i=>{
let galeria=i.imagenes.map(img=>`<img src="${img}">`).join('');
document.getElementById("detalle-chisme").innerHTML=`
<h2>${i.nombre} ${i.apellido}</h2>
<p><b>Reportado por:</b> ${i.reportero}</p>
<p><b>Ubicación:</b> ${i.ubicacion}</p>

<h3>Historia</h3>
<p>${i.historia}</p>

<h3>Pruebas</h3>
${galeria||'Sin pruebas'}

<h3>Votación</h3>
<div class="votos">
<button class="voto-btn verde" onclick="alert('Aprobado')">Aprobar</button>
<button class="voto-btn rojo" onclick="alert('Refutado')">Refutar</button>
<button class="voto-btn naranja" onclick="alert('Denunciado')">Denunciar</button>
</div>

<div class="progress"><div class="bar" style="width:40%;background:var(--verde)"></div></div>
<div class="progress"><div class="bar" style="width:35%;background:var(--rojo)"></div></div>
<div class="progress"><div class="bar" style="width:25%;background:var(--naranja)"></div></div>

<h3>Comentarios</h3>
<div class="comentarios" id="comentarios"></div>

<input id="nick" placeholder="Tu nick (opcional)">
<textarea id="comentario"></textarea>
<button class="btn btn-azul" onclick="comentar()">Comentar</button>
`;
document.getElementById("modal-detalle").classList.add("active");
});
}

function comentar(){
const nick=document.getElementById("nick").value||"Anónimo";
const txt=document.getElementById("comentario").value;
document.getElementById("comentarios").innerHTML+=`
<div class="comentario"><b>${nick}:</b> ${txt}</div>`;
document.getElementById("comentario").value='';
}
</script>
</body>
</html>

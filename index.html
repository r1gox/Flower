<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro Nacional de Infieles</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{--azul:#007bff;--rojo:#dc3545;--naranja:#fd7e14;--fondo:#f8f9fa;--blanco:#fff;--gris:#6c757d}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui;max-width:500px;margin:auto;background:#f8f9fa}

header{text-align:center;padding:30px;background:white}
.btn{padding:14px;border:none;border-radius:10px;font-weight:bold;width:100%;margin-top:10px}
.btn-azul{background:#007bff;color:white}
.btn-rojo{background:#dc3545;color:white}
.btn-naranja{background:#fd7e14;color:white}

.card{background:white;border-radius:15px;margin:15px;overflow:hidden;box-shadow:0 4px 18px rgba(0,0,0,.1)}
.card-header{background:#007bff;color:white;padding:15px;text-align:center}
.card-body{padding:15px}

.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);justify-content:center;align-items:center;z-index:5}
.modal.active{display:flex}
.modal-content{background:white;width:100%;height:95vh;border-radius:20px;overflow:auto;padding:20px}

.galeria img{width:100%;border-radius:10px;margin:10px 0}
.barra{height:10px;border-radius:10px;background:#eee;overflow:hidden;margin:6px 0}
.barra span{display:block;height:100%}

.comentario{background:#f1f3f5;padding:12px;border-radius:10px;margin:10px 0}

.progreso{display:none;text-align:center;padding:10px;font-weight:bold}
</style>
</head>

<body>

<header>
<h1>Registro de Infieles</h1>
<button class="btn btn-azul" onclick="document.getElementById('modal-form').classList.add('active')">+ Exponer</button>
</header>

<div id="lista-infieles"></div>

<!-- FORM -->
<div id="modal-form" class="modal">
<div class="modal-content">
<button class="btn btn-rojo" onclick="cerrarModal()">Cerrar</button>

<form id="form-infiel">
<input id="reportero" placeholder="Tu nick (opcional)">
<input id="nombre" placeholder="Nombre" required>
<input id="apellido" placeholder="Apellido" required>
<input id="edad" type="number" placeholder="Edad" required>
<input id="ubicacion" placeholder="D贸nde vive" required>
<textarea id="historia" placeholder="Detalles completos" required></textarea>
<input type="file" id="pruebas" multiple>

<div id="progreso" class="progreso">Subiendo pruebas...</div>

<button class="btn btn-azul">Publicar Chisme</button>
</form>
</div>
</div>

<!-- DETALLE -->
<div id="modal-chisme" class="modal">
<div class="modal-content">
<button class="btn btn-rojo" onclick="cerrarDetalle()">Cerrar</button>
<div id="detalle-chisme"></div>
</div>
</div>

<script>
function cerrarModal(){document.getElementById('modal-form').classList.remove('active')}
function cerrarDetalle(){document.getElementById('modal-chisme').classList.remove('active')}

document.getElementById('form-infiel').onsubmit=async e=>{
e.preventDefault()
document.getElementById('progreso').style.display="block"

const files=[...pruebas.files]
const imgs=[]
for(let f of files){
const fr=new FileReader()
await new Promise(r=>{
fr.onload=()=>{imgs.push(fr.result);r()}
fr.readAsDataURL(f)
})
}

await fetch('/.netlify/functions/infieles',{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
reportero:reportero.value||"An贸nimo",
nombre:nombre.value,
apellido:apellido.value,
edad:edad.value,
ubicacion:ubicacion.value,
historia:historia.value,
imagenes:imgs
})
})

document.getElementById('progreso').style.display="none"
cerrarModal()
cargarInfieles()
alert("Publicado correctamente")
}

async function cargarInfieles(){
const r=await fetch('/.netlify/functions/infieles')
const rows=await r.json()
const cont=document.getElementById('lista-infieles')
cont.innerHTML=""
rows.forEach(i=>{
cont.innerHTML+=`
<div class="card">
<div class="card-header">${i.nombre} ${i.apellido}</div>
<div class="card-body">
<p><b>De:</b> ${i.ubicacion}</p>
<button class="btn btn-azul" onclick="verChisme(${i.id})">Ver todo el chisme</button>
</div>
</div>`
})
}

async function verChisme(id){
const r=await fetch('/.netlify/functions/infieles?id='+id)
const i=await r.json()

const total=i.aprobados+i.refutados+i.denunciados||1
const pA=(i.aprobados/total*100).toFixed(0)
const pR=(i.refutados/total*100).toFixed(0)
const pD=(i.denunciados/total*100).toFixed(0)

document.getElementById('detalle-chisme').innerHTML=`
<h2>${i.nombre} ${i.apellido}</h2>

<p><b>Ubicaci贸n:</b> ${i.ubicacion}</p>
<p><b>Privacidad:</b> Identidad protegida</p>

<h3>Detalles</h3>
<p>${i.historia}</p>

<h3>Pruebas iniciales</h3>
<div class="galeria">${(i.imagenes||[]).map(img=>`<img src="${img}">`).join("")}</div>

<h3>Votaci贸n</h3>
<div class="barra"><span style="width:${pA}%;background:green"></span></div>
<div class="barra"><span style="width:${pR}%;background:#fd7e14"></span></div>
<div class="barra"><span style="width:${pD}%;background:red"></span></div>

<button class="btn btn-azul">Aprobar</button>
<button class="btn btn-naranja">Refutar</button>
<button class="btn btn-rojo">Denunciar</button>

<h3>Comentarios</h3>
<div>${(i.comentarios||[]).map(c=>`
<div class="comentario">
<b>${c.nick}</b><br>${c.texto}
${c.img?`<img src="${c.img}" style="width:100%">`:""}
</div>`).join("")}</div>

<input placeholder="Tu nick (opcional)">
<textarea placeholder="Comentario"></textarea>
<input type="file">
<button class="btn btn-azul">Enviar comentario</button>
`

document.getElementById('modal-chisme').classList.add('active')
}

cargarInfieles()
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro Nacional de Infieles</title>
  <style>
    :root{--azul:#007bff;--rojo:#dc3545;--naranja:#ff9f1a;--verde:#28a745;--fondo:#f8f9fa;--blanco:#fff;--gris:#6c757d;--texto:#212529}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,Arial,sans-serif;background:var(--fondo);color:var(--texto);max-width:500px;margin:0 auto;min-height:100vh;padding-bottom:60px}
    #solo-pc{display:none;text-align:center;padding:60px;background:#fff;min-height:100vh;font-size:1.3em}
    @media(min-width:768px){body>*:not(#solo-pc){display:none}#solo-pc{display:block}}
    header{text-align:center;padding:25px 15px;background:var(--blanco);border-bottom:5px solid var(--azul);box-shadow:0 3px 10px rgba(0,123,255,.15)}
    h1{font-size:1.8em;color:var(--azul)}
    .btn{padding:12px 16px;font-size:1.02em;border:none;border-radius:10px;cursor:pointer;font-weight:700;margin:10px 8px;width:88%}
    .btn-azul{background:var(--azul);color:white}
    .btn-rojo{background:var(--rojo);color:white}
    .btn-ver{padding:10px 12px;background:var(--azul);color:white;border-radius:10px;border:none}
    #search-section{padding:18px 12px;background:var(--blanco);text-align:center}
    #search-input{width:94%;padding:12px;border:2px solid #ced4da;border-radius:30px;font-size:1.05em;text-align:center}
    #lista-infieles{padding:12px;display:flex;flex-direction:column;gap:14px}
    .card{background:var(--blanco);border-radius:12px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.08);border:1px solid #e9ecef;display:flex;flex-direction:column}
    .card-header{background:linear-gradient(90deg,var(--azul),#0056d6);color:white;padding:12px;text-align:center;font-size:1.05em;font-weight:800}
    .card-body{padding:12px}
    .info{margin:8px 0;color:var(--gris);font-size:.95em}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);z-index:1000;justify-content:center;align-items:center;padding:12px}
    .modal.active{display:flex}
    .modal-content{background:white;border-radius:12px;padding:18px;width:100%;max-height:92vh;overflow-y:auto;position:relative}
    .close{position:absolute;top:10px;right:12px;font-size:28px;cursor:pointer;color:#999}
    .galeria img,.comentario img{width:100%!important;height:auto!important;border-radius:8px;margin:12px 0;display:block;box-shadow:0 2px 10px rgba(0,0,0,.12)}
    label{display:block;margin:12px 0 6px;font-weight:700}
    input,textarea,select{width:100%;padding:12px;border:1.5px solid #ddd;border-radius:10px;font-size:1em}
    textarea{min-height:100px}
    .votos{display:flex;gap:8px;margin:12px 0}
    .voto-btn{flex:1;padding:10px;border-radius:8px;color:white;border:none;font-weight:800;cursor:pointer}
    .voto-btn.disabled{background:#ccc!important;cursor:not-allowed!important}
    .comentarios{margin-top:14px;border-top:2px solid #eee;padding-top:12px}
    .comentario{background:#f8f9fa;padding:10px;border-radius:10px;margin:10px 0;border-left:4px solid var(--azul)}
    .upload-bar{height:6px;background:#eee;border-radius:6px;overflow:hidden;margin-top:8px}
    .upload-progress{height:6px;background:linear-gradient(90deg,var(--azul),#00c3ff);width:0%}
    .small{font-size:.9em;color:#666;margin-top:6px}
    .summary{color:#444;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .percent-block{display:flex;gap:6px;align-items:center}
    .percent-pill{padding:6px 8px;border-radius:999px;background:#f1f3f5;font-weight:700}
  </style>
</head>
<body>

<div id="solo-pc"><h2>Este sitio es solo para celulares</h2><p>Abre desde tu telÃ©fono</p></div>

<div id="age-modal" class="modal active">
  <div class="modal-content">
    <h2>ConfirmaciÃ³n de Edad</h2>
    <p>Este contenido es solo para mayores de 18 aÃ±os</p>
    <button class="btn btn-azul" onclick="confirmAge(true)">SÃ­, tengo 18+</button>
    <button class="btn btn-rojo" onclick="confirmAge(false)">No</button>
  </div>
</div>

<div id="main-content" style="display:none;">
  <header>
    <h1>Registro de Infieles</h1>
    <p class="small">El chisme que todos quieren ver â€” entretenimiento y sÃ¡tira</p>
    <button class="btn btn-azul" id="btn-agregar">+ Exponer Infiel</button>
    <button class="btn btn-rojo" id="btn-legal">InformaciÃ³n Legal</button>
  </header>

  <section id="search-section">
    <input id="search-input" placeholder="Buscar por nombre o ciudad..." onkeyup="filtrar()" />
  </section>

  <div id="lista-infieles"></div>
</div>

<!-- Modal Formulario -->
<div id="modal-form" class="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarModal()">Ã—</span>
    <h2>Nuevo Chisme</h2>
    <form id="form-infiel">
      <label>Tu nick (opcional)</label>
      <input id="reportero" placeholder="Tu nick (o deja en blanco para AnÃ³nimo)"/>
      <label>Nombre</label>
      <input id="nombre" required/>
      <label>Apellido</label>
      <input id="apellido" required/>
      <label>Edad</label>
      <input id="edad" type="number" min="18" required/>
      <label>UbicaciÃ³n</label>
      <input id="ubicacion" required/>
      <label>Detalles (historia)</label>
      <textarea id="historia" required></textarea>
      <label>Pruebas (fotos o links)</label>
      <input id="pruebas" type="file" accept="image/*" multiple />
      <div id="upload-status" class="small"></div>
      <div class="upload-bar"><div id="upload-progress" class="upload-progress"></div></div>
      <button type="submit" class="btn btn-azul" style="margin-top:12px">Publicar Chisme</button>
    </form>
  </div>
</div>

<!-- Modal Detalle -->
<div id="modal-chisme" class="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarDetalle()">Ã—</span>
    <div id="detalle-chisme"></div>
  </div>
</div>

<!-- Modal Legal -->
<div id="modal-legal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarLegal()">Ã—</span>
    <h2>PolÃ­tica y Advertencias</h2>
    <p><strong>Entretenimiento y sÃ¡tira.</strong> No publiques datos de menores ni material ilegal.</p>
    <p>Usas bajo tu responsabilidad.</p>
    <button class="btn btn-rojo" onclick="cerrarLegal()">Entendido</button>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
function $q(id){return document.getElementById(id);}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

/* ---------- age modal & UI ---------- */
function confirmAge(ok){
  if(ok){
    $q('age-modal').classList.remove('active');
    $q('main-content').style.display='block';
    cargarInfieles();
  } else location.href='https://google.com';
}
$q('btn-agregar').onclick = ()=> $q('modal-form').classList.add('active');
$q('btn-legal').onclick = ()=> $q('modal-legal').classList.add('active');
function cerrarLegal(){ $q('modal-legal').classList.remove('active'); }
function cerrarModal(){ $q('modal-form').classList.remove('active'); $q('form-infiel').reset(); $q('upload-status').textContent=''; $q('upload-progress').style.width='0%'; }
function cerrarDetalle(){ $q('modal-chisme').classList.remove('active'); }

/* ---------- upload animation + base64 ---------- */
function toBase64(file, onProgress){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = reject;
    // no native progress on FileReader for readAsDataURL; simulate small animation
    fr.readAsDataURL(file);
    if(onProgress){
      let p=0;
      const iv = setInterval(()=>{
        p = Math.min(95, p + 8);
        onProgress(p);
        if(fr.readyState === 2){ // DONE
          onProgress(100);
          clearInterval(iv);
        }
      },120);
    }
  });
}

/* ---------- submit new chisme ---------- */
$q('form-infiel').onsubmit = async e=>{
  e.preventDefault();
  const files = $q('pruebas').files;
  const imgs = [];
  $q('upload-status').textContent = 'Preparando pruebas...';
  for(let f of files){
    if(!f.type.startsWith('image/')) continue;
    $q('upload-status').textContent = `Subiendo ${f.name}...`;
    const base = await toBase64(f, pct => { $q('upload-progress').style.width = pct + '%'; });
    imgs.push(base);
    await sleep(120); // pequeÃ±a pausa para animaciÃ³n
  }
  $q('upload-status').textContent = 'Finalizando...';
  $q('upload-progress').style.width = '100%';

  const payload = {
    reportero: $q('reportero').value.trim() || 'AnÃ³nimo',
    nombre: $q('nombre').value.trim(),
    apellido: $q('apellido').value.trim(),
    edad: Number($q('edad').value),
    ubicacion: $q('ubicacion').value.trim(),
    historia: $q('historia').value.trim(),
    imagenes: imgs,
    votos: { aprobar: 0, refutar: 0, denunciar: 0 },
    comentarios: []
  };

  await fetch('/.netlify/functions/infieles', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  cerrarModal();
  cargarInfieles();
  alert('Â¡Chisme publicado con Ã©xito!');
};

/* ---------- cargar lista (resumen) ---------- */
async function cargarInfieles(){
  const res = await fetch('/.netlify/functions/infieles');
  const rows = await res.json();
  const cont = $q('lista-infieles');
  if(!rows || rows.length===0){
    cont.innerHTML = '<p style="text-align:center;padding:40px;color:#666">AÃºn no hay chismes...</p>';
    return;
  }
  cont.innerHTML = '';
  rows.forEach(i=>{
    const card = document.createElement('div'); card.className='card';
    // compute total votes & percentages
    const votos = i.votos || { aprobar:0, refutar:0, denunciar:0 };
    const total = (votos.aprobar||0) + (votos.refutar||0) + (votos.denunciar||0) || 0;
    const pct = (n)=> total? Math.round((n/total)*100) : 0;

    card.innerHTML = `
      <div class="card-header">${i.nombre} ${i.apellido}, ${i.edad} aÃ±os</div>
      <div class="card-body">
        <div class="info"><strong>Reportado por:</strong> ${i.reportero}</div>
        <div class="info"><strong>De:</strong> ${i.ubicacion}</div>
        <div class="summary">${escapeHtml(String(i.resumen || ''))}...</div>
        <div class="meta">
          <div class="percent-block">
            <span class="percent-pill">ðŸŸ¢ ${pct(votos.aprobar||0)}%</span>
            <span class="percent-pill">ðŸŸ  ${pct(votos.refutar||0)}%</span>
            <span class="percent-pill">ðŸ”´ ${pct(votos.denunciar||0)}%</span>
          </div>
          <button class="btn-ver" onclick="verChisme(${i.id})">Ver todo el chisme</button>
        </div>
      </div>
    `;
    cont.appendChild(card);
  });
}

/* ---------- ver detalle (completo) ---------- */
async function verChisme(id){
  const res = await fetch('/.netlify/functions/infieles?id=' + id);
  const i = await res.json();

  // votos data
  const votos = i.votos || { aprobar:0, refutar:0, denunciar:0 };
  const total = (votos.aprobar||0) + (votos.refutar||0) + (votos.denunciar||0);
  const pct = (n)=> total? Math.round((n/total)*100) : 0;

  // build gallery HTML
  const gal = (i.imagenes && i.imagenes.length) ? i.imagenes.map(src=>`<img src="${src}">`).join('') : '<p style="color:#888">Sin pruebas visuales</p>';

  // comments
  const coms = (i.comentarios && i.comentarios.length) ? i.comentarios.map(c=>`
    <div class="comentario">
      <strong>${escapeHtml(c.nick || 'AnÃ³nimo')}:</strong>
      <div>${escapeHtml(c.texto).replace(/\n/g,'<br>')}</div>
      ${c.imgOrLink? (c.imgOrLink.startsWith('data:') ? `<img src="${c.imgOrLink}">` : `<a href="${escapeAttr(c.imgOrLink)}" target="_blank">Ver adjunto</a>`) : ''}
      <small class="small">${new Date(c.fecha).toLocaleString()}</small>
    </div>
  `).join('') : '<p style="color:#888">AÃºn no hay comentarios</p>';

  $q('detalle-chisme').innerHTML = `
    <h2>${escapeHtml(i.nombre)} ${escapeHtml(i.apellido)}</h2>
    <p class="small"><strong>Reportado por:</strong> ${escapeHtml(i.reportero)}</p>
    <p class="small"><strong>UbicaciÃ³n:</strong> ${escapeHtml(i.ubicacion)}</p>

    <hr>
    <h3>PolÃ­tica de privacidad</h3>
    <p class="small">Este sitio es de entretenimiento. No publiques datos de menores ni material ilegal.</p>

    <h3>InformaciÃ³n personal</h3>
    <p class="small">Edad: ${escapeHtml(String(i.edad))}</p>

    <h3>Detalles de la infidelidad</h3>
    <p style="background:#f1f3f5;padding:12px;border-radius:8px">${escapeHtml(i.historia).replace(/\n/g,'<br>')}</p>

    <h3>Pruebas iniciales</h3>
    <div class="galeria">${gal}</div>

    <div style="margin-top:12px" class="votos">
      <button id="btnAprobar" class="voto-btn" style="background:var(--verde)" onclick="votar(${i.id},'aprobar')">ðŸŸ¢ Aprobar (${votos.aprobar||0})</button>
      <button id="btnRefutar" class="voto-btn" style="background:var(--naranja);color:black" onclick="votar(${i.id},'refutar')">ðŸŸ  Refutar (${votos.refutar||0})</button>
      <button id="btnDenunciar" class="voto-btn" style="background:var(--rojo)" onclick="votar(${i.id},'denunciar')">ðŸ”´ Denunciar (${votos.denunciar||0})</button>
    </div>
    <div class="small">Totales: ðŸŸ¢ ${pct(votos.aprobar||0)}% â€¢ ðŸŸ  ${pct(votos.refutar||0)}% â€¢ ðŸ”´ ${pct(votos.denunciar||0)}%</div>

    <div class="comentarios">
      <h3>Comentarios y pruebas adicionales</h3>
      ${coms}
      <label>Nick (opcional)</label>
      <input id="nick-coment" placeholder="Tu nick o deja en blanco para AnÃ³nimo">
      <label>Comentario</label>
      <textarea id="texto-coment" placeholder="Escribe tu comentario..."></textarea>
      <label>Agregar foto o link (opcional)</label>
      <input type="file" id="img-coment" accept="image/*">
      <input type="text" id="link-coment" placeholder="o pega un link aquÃ­">
      <div id="upload-comment-status" class="small"></div>
      <button class="btn btn-azul" onclick="enviarComentario(${i.id})" style="margin-top:8px">Enviar Comentario</button>
    </div>
  `;

  $q('modal-chisme').classList.add('active');
}

/* ---------- votar ---------- */
async function votar(id,tipo){
  const key = 'voto_'+id;
  if(localStorage.getItem(key) === tipo) {
    alert('Ya votaste de esta forma en este chisme');
    return;
  }
  // send vote
  const res = await fetch('/.netlify/functions/infieles?action=vote', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id, tipo })
  });
  if(!res.ok) return alert('Error al votar');
  const votos = await res.json();
  localStorage.setItem(key, tipo);
  verChisme(id); // refresh
}

/* ---------- comentarios ---------- */
async function enviarComentario(id){
  const nick = $q('nick-coment').value.trim() || 'AnÃ³nimo';
  const texto = $q('texto-coment').value.trim();
  const file = $q('img-coment').files[0];
  const link = $q('link-coment').value.trim() || null;
  if(!texto) return alert('Escribe algo en el comentario');

  let imgOrLink = link;
  if(file && file.type.startsWith('image/')) {
    $q('upload-comment-status').textContent = 'Subiendo imagen...';
    imgOrLink = await toBase64(file, pct => { /* no need to show progress here */ });
    $q('upload-comment-status').textContent = '';
  }

  const res = await fetch('/.netlify/functions/infieles?action=comment', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id, nick, texto, imgOrLink })
  });

  if(!res.ok) return alert('Error al enviar comentario');
  $q('texto-coment').value='';
  $q('img-coment').value='';
  $q('link-coment').value='';
  verChisme(id);
}

/* ---------- search filter ---------- */
function filtrar(){
  const txt = $q('search-input').value.toLowerCase();
  document.querySelectorAll('.card').forEach(c=>{
    c.style.display = c.textContent.toLowerCase().includes(txt) ? 'flex' : 'none';
  });
}

/* ---------- small helpers ---------- */
function escapeHtml(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}
function escapeAttr(s){ return escapeHtml(s); }

/* ---------- on load ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // nothing special; waiting for age confirmation
});
</script>
</body>
</html>
